<!--term.html-->
{% extends 'template.html' %}
{% block title %}{{termin.datum.strftime('%d.%m.%Y')}}{% endblock %}
{% block nav %}
    {% include 'nav_bar.html' %}
{% endblock %}
{% block main %}
<main class="term-main">
    <div class="column-div">
        <div class="term-container">       
            <h3>Datum: {{termin.datum.strftime('%d.%m.%Y')}}</h3>
            <h3>Místa: {{termin.max_ridicu}}</h3>
            <h3>Volná místa: {{ volna_mista }}</h3> 
        </div>
        <input type="hidden" id="max-forms" value="{{ volna_mista }}">
        {% if zaci_Y %}
            <div class="students-container-10" id="students_container">
                <div class="student-line">
                    <div style="font-weight: bold;">E.Č.</div>
                    <div style="font-weight: bold;">Jméno</div>
                    <div style="font-weight: bold;">Příjmení</div>
                    <div style="font-weight: bold;">Narození</div>
                    <div style="font-weight: bold;">Začátek výcviku</div>
                    <div style="font-weight: bold;">Konec výcviku</div>
                    <div style="font-weight: bold;">První pokus</div>
                    <div style="font-weight: bold;">Typ zkoušky</div>
                    <div style="font-weight: bold;">Druh zkoušky</div>
                    <div style="font-weight: bold;">Začátek</div>          
                </div>
                {% for zak in zaci_Y %}
                    <div class="student-line" id="zak_{{ zak['id'] }}">
                        <div>{{ zak['ev_cislo']}}</div>
                        <div>{{ zak['jmeno']}}</div>
                        <div>{{ zak['prijmeni']}}</div>
                        <div>{{ zak['narozeni'].strftime('%d.%m.%Y')}}</div>
                        <div>{{ zak['zacatek'].strftime('%d.%m.%Y') if zak['zacatek'] else ''}}</div>
                        <div>{{ zak['konec'].strftime('%d.%m.%Y') if zak['konec'] else ''}}</div>
                        <div>{{ zak['prvni'].strftime('%d.%m.%Y') if zak['prvni'] else ''}}</div>
                        <div>{{ zak['typ_zkousky']}}</div>
                        <div>{{ zak['druh_zkousky']}}</div>
                        <div>{{ zak['cas']}}</div>
                    </div> 
                {% endfor %}
            </div>
        {% endif %}
        {% if zaci_W %}
            <div class="students-container_button-10" id="students_container">
                <div class="student-line">
                    <div style="font-weight: bold;">E.Č.</div>
                    <div style="font-weight: bold;">Jméno</div>
                    <div style="font-weight: bold;">Příjmení</div>
                    <div style="font-weight: bold;">Narození</div>
                    <div style="font-weight: bold;">Začátek výcviku</div>
                    <div style="font-weight: bold;">Konec výcviku</div>
                    <div style="font-weight: bold;">První pokus</div>
                    <div style="font-weight: bold;">Typ zkoušky</div>
                    <div style="font-weight: bold;">Druh zkoušky</div>
                    <div style="font-weight: bold;">Smazat</div>          
                </div>
                {% for zak in zaci_W %}
                    <div class="student-line" id="zak_{{ zak['id'] }}">
                        <div>{{ zak['ev_cislo']}}</div>
                        <div>{{ zak['jmeno']}}</div>
                        <div>{{ zak['prijmeni']}}</div>
                        <div>{{ zak['narozeni'].strftime('%d.%m.%Y')}}</div>
                        <div>{{ zak['zacatek'].strftime('%d.%m.%Y') if zak['zacatek'] else ''}}</div>
                        <div>{{ zak['konec'].strftime('%d.%m.%Y') if zak['konec'] else ''}}</div>
                        <div>{{ zak['prvni'].strftime('%d.%m.%Y') if zak['prvni'] else ''}}</div>
                        <div>{{ zak['typ_zkousky']}}</div>
                        <div>{{ zak['druh_zkousky']}}</div>
                        <button class="delete-student" id="delete-student" data-zakId="{{zak['id']}}" data-terminId="{{termin.id}}">Smazat</button>
                    </div> 
                {% endfor %}
            </div>
        {% endif %}
        {% if volna_mista > 0 %}
            <div class="students-container-admin" style="display: none;" id="result">
                <div class="grid-for-9-align">
                    <div style="font-weight: bold;">E.Č.</div>
                    <div style="font-weight: bold;">Jméno</div>
                    <div style="font-weight: bold;">Příjmení</div>
                    <div style="font-weight: bold;">Narození</div>
                    <div style="font-weight: bold;">Začátek výcviku</div>
                    <div style="font-weight: bold;">Konec výcviku</div>
                    <div style="font-weight: bold;">První pokus</div>
                    <div style="font-weight: bold;">Typ zkoušky</div>
                    <div style="font-weight: bold;">Druh zkoušky</div>
                </div>
                <div id="result-content"></div> <!-- Sekce pro data -->
                <div class="center-div">
                    <button type="button" onclick="sendAllStudentIds()" id="sendButton">Odeslat ID</button>
                </div>
            </div>
            <div class="div-select">
                <div>
                    <label for="evidencniCislo">Evidenční číslo:</label>
                    <input class="input-box3" type="text" id="evidencniCislo">
                </div>
                <div class="center-div" style="margin-top: 10px;">
                    <button type="button" onclick="fetchStudent()">Odeslat</button>
                </div>
            </div>
        {% endif %}
    </div>
</main>
    <script src="{{ url_for('static', filename='deferScript_term.js') }}" defer></script>
<script>
    async function sendAllStudentIds() {
            const resultSection = document.getElementById("result");
            const studentDivs = resultSection.querySelectorAll('[data-student-id]');

            // Mapování ID a hodnot z selectů
            const studentsData = Array.from(studentDivs).map(div => {
                const studentId = div.getAttribute('data-student-id');
                const licenseCategory = div.querySelector('[name="license_category"]').value;
                const examType = div.querySelector('[name="exam_type"]').value;

                return {
                    id: studentId,
                    license_category: licenseCategory,
                    exam_type: examType
                };
            });

            try {
                const response = await fetch('/api/add_drivers_as', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ students: studentsData }),
                });

                if (!response.ok) {
                    throw new Error('Chyba při odesílání dat studentů.');
                }

                alert('Data studentů byla úspěšně odeslána.');
                window.location.reload()
            } catch (error) {
                alert(error.message);
            }
        }

    let list_ev = [];

    async function fetchStudent() {
        // Get selected values
        const evidencniCislo = document.getElementById("evidencniCislo").value;


        if (!evidencniCislo) {
            alert("Prosím, vyplňte pole.");
            return;
        }

        if (list_ev.includes(evidencniCislo)) {
        alert("Toto evidenční číslo již bylo zadáno.");
        return;
        }

        list_ev.push(evidencniCislo);

        try {
            const response = await fetch("/api/get_student_as", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    evidencniCislo: evidencniCislo,
                }),
            });

            if (!response.ok) {
                const errorMessage = await response.json();
                alert(errorMessage.error || 'Nastala chyba při získávání údajů o studentovi.');
                return;
            }

            const data = await response.json();

            // Format the date to dd.mm.yyyy
            const formattedDateBirth = new Date(data.dat_nar).toLocaleDateString('cs-CZ');
            const formattedDateStart = new Date(data.zacatek).toLocaleDateString('cs-CZ');
            const formattedDateEnd = new Date(data.konec).toLocaleDateString('cs-CZ');
            
            data.dat_nar = formattedDateBirth;
            data.zacatek = formattedDateStart;
            data.konec = formattedDateEnd;

            // Přidání záznamu do `result-content` na začátek
    const resultSection = document.getElementById("result");
    const resultContent = document.getElementById("result-content");
    resultSection.style.display = 'block';

    const prvniDatum = data.prvni ? new Date(data.prvni).toISOString().split('T')[0] : '';

    const studentHTML = `
        <div data-student-id="${data.id}" class="grid-for-9-align">
            <p style= margin-top:3px;margin-bottom:3px;>${data.ev_cislo}</p>
            <p style= margin-top:3px;margin-bottom:3px;>${data.jmeno}</p>
            <p style= margin-top:3px;margin-bottom:3px;>${data.prijmeni}</p>
            <p style= margin-top:3px;margin-bottom:3px;>${data.dat_nar}</p>
            <p style= margin-top:3px;margin-bottom:3px;>${data.zacatek}</p>
            <p style= margin-top:3px;margin-bottom:3px;>${data.konec}</p>
            <p style= margin-top:3px;margin-bottom:3px;>${prvniDatum}</p>
            <input class="input-box3" name="license_category" type="text" placeholder="Např. B, B+E, T" required title="Zadej skupiny ŘP oddělené čárkou (např. B, B+E)">    
            <div class="form-group">
                <select name="exam_type" id="exam_type">
                    <option value="Řádná_zkouška" selected>Řádná zkouška</option>
                    <option value="Opravná_zkouška-test+jízda">Opravná zkouška (jízda+test)</option>
                    <option value="Opravná_zkouška-jízda">Opravná zkouška (jízda)</option>
                    <option value="Opravná_zkouška-technika">Opravná zkouška (technika)</option>
                    <option value="Opravná_zkouška-technika+jízda">Opravná zkouška (technika+jízda)</option>
                    <option value="Profesní_způsobilost-test">Profesní způsobilost</option>
                </select>
            </div>
        </div>
    `;
    resultContent.insertAdjacentHTML('afterbegin', studentHTML); // Přidání na začátek
        } catch (error) {
            alert(error.message);
            messageBox.style.color = 'red';
            messageBox.style.marginTop = '20px';
        }
    }
</script>
{% endblock %}